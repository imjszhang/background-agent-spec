---
description: Background Agent(BGA)人机协作并行工作流规则 - 智能识别触发条件、标准化规划生成、强制状态跟踪和多方反馈管理
globs: ["**/*.js", "**/*.md", "**/todos/**", "**/scripts/**"]
alwaysApply: false
---

# Background Agent (BGA) 工作流规则

## 版本信息
- **当前版本**: v1.0.0
- **发布日期**: 2025-08-03
- **版本状态**: 首发版本 (Initial Release)
- **基于文档**: `docs/specs/spec.backgroundAgent.README.md` v1.3.0
- **兼容性**: 与 spec.backgroundAgent.README.md 完全兼容
- **更新说明**: 基于完整规范文档提取的核心工作流规则，适用于 Cursor IDE 的 .cursor/rules 集成

## 触发条件智能识别

### 关键词触发检测
当用户输入包含以下任一关键词时，**必须**触发BGA工作流：

**主要触发词**：
- `BGA` / `bga` / `Background Agent` / `后台代理` / `后台助手`

**动作触发词**：
- `执行` + 规划编号（如"执行P001"）
- `运行` + 规划编号（如"运行P002"）  
- `启动` + 规划编号（如"启动P003"）

**查询触发词**：
- 规划编号 + `状态`/`进度`/`结果`（如"P001状态"）
- `查看` + 规划编号（如"查看P001"）

**反馈触发词**：
- `反馈` + 规划编号（如"反馈P001"）
- `建议` + 规划编号（如"建议P001"）
- `评价` + 规划编号（如"评价P001"）
- `优化` + 规划编号（如"优化P002"）

### 上下文智能触发
即使未明确提及BGA，以下情况也**必须**触发工作流：
- 复杂多步骤任务描述（≥3个独立步骤）
- 包含"批量"、"自动化"、"并行"等关键词
- 涉及多个文件或模块的操作
- 包含"帮我规划"、"制定计划"等表述
- 反馈收集场景（"有什么建议"、"如何改进"等）

## 新任务规划生成流程

### 严格按序执行的五步流程
**新任务规划必须严格按以下步骤执行，不可跳过或调换顺序**：

#### 第一步：获取当前时间（强制要求）
```javascript
// 必须使用 mcp_time_get_current_time 工具
await mcp_time_get_current_time({
  timezone: "Asia/Shanghai"
});
```

#### 第二步：分析TODOS目录结构（强制要求）
```javascript
// 必须使用 list_dir 工具扫描 todos/ 目录
await list_dir({
  relative_workspace_path: "todos/"
});
// 分析现有规划数量、已使用编号、目录完整性
```

#### 第三步：建立新规划文件夹结构
```
todos/P00X/
├── plan.json          # 规划配置文件
├── todolist.md        # 任务清单文件  
├── rationale.md       # 执行理由文件
├── feedback.md        # 反馈记录文件
└── reports/           # 执行报告目录
```

#### 第四步：生成核心规划文件
按以下顺序依次生成：
1. **plan.json** - 完整配置和文件引用
2. **todolist.md** - 标准Markdown任务列表
3. **rationale.md** - 详细执行理由
4. **feedback.md** - 空白反馈模板

#### 第五步：流程结束确认
- 验证所有文件创建成功
- 通知用户规划生成完成
- **禁止自动执行** - 必须等待用户明确指令

### plan.json标准结构
```json
{
  "plan_id": "P001",
  "title": "规划标题",
  "description": "规划描述", 
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z",
  "status": "pending",
  "referenced_files": {
    "core_files": ["modules/agent.js", "modules/browserAutomation.js"],
    "config_files": ["data/llm_config.example.json"],
    "documentation": ["docs/modules/module.agent.README.md"],
    "test_files": ["test/agent.test.js"]
  },
  "tasks": [
    {
      "id": 1,
      "title": "任务标题",
      "description": "任务描述",
      "status": "pending",
      "dependencies": [],
      "estimated_time": "30min",
      "related_files": ["specific/file.js"]
    }
  ],
  "execution_history": [],
  "metadata": {
    "total_tasks": 5,
    "estimated_total_time": "2hours",
    "complexity": "medium",
    "priority": "high"
  }
}
```

## 执行流程规范

### 执行前强制要求

#### 1. 上下文读取（read_context）- 必须执行
**并行读取所有必要文件**：
- **核心规划文件**：plan.json、todolist.md、rationale.md、feedback.md
- **项目相关文件**：plan.json中referenced_files字段的所有文件
- **执行历史文件**（继续执行时）：reports/目录下所有执行报告
- **产出文件**（继续执行时）：历史报告中的generated_files和modified_files

```javascript
// 示例：并行读取上下文文件
const contextFiles = [
  `todos/${planId}/plan.json`,
  `todos/${planId}/todolist.md`,
  `todos/${planId}/rationale.md`, 
  `todos/${planId}/feedback.md`,
  ...referencedFiles,
  ...reportFiles,
  ...generatedFiles
];

// 使用并行read_file调用
await Promise.all(
  contextFiles.map(file => read_file(file))
);
```

#### 2. 执行前验证
- 规划有效性检查
- 依赖关系验证
- 资源可用性检查
- 文件状态验证

### 强制状态跟踪（todo_write）

#### 任务状态管理规范
todolist.md使用标准状态标记，**执行过程中必须严格更新**：

```markdown
## 任务清单

- [ ] 1. 任务名称 - 待执行 (pending)
- [~] 2. 任务名称 - 执行中 (in_progress)  
- [x] 3. 任务名称 - 已完成 (completed)
- [!] 4. 任务名称 - 执行失败 (failed)
- [-] 5. 任务名称 - 已跳过 (skipped)
```

#### 强制状态更新要求
1. **任务开始时**：必须将状态从`[ ]`更新为`[~]`
2. **任务完成时**：必须将状态从`[~]`更新为`[x]`或`[!]`
3. **实时同步**：todolist.md状态必须与实际执行进度同步
4. **状态验证**：执行结束前必须验证所有任务状态正确更新

#### todo_write工具实现
```javascript
// 使用 search_replace 或 MultiEdit 工具直接修改 todolist.md
await search_replace({
  file_path: `todos/${planId}/todolist.md`,
  old_string: "- [ ] 1. 任务名称",
  new_string: "- [~] 1. 任务名称"
});
```

## 执行报告生成规范

### 强制报告生成要求
每次执行完成后**必须**创建执行报告：

#### 报告命名格式
```
todos/P00X/reports/exec_序号_YYYY-MM-DD_HH-mm.md
```

#### 标准报告模板
```markdown
# 规划执行报告 - exec_001_YYYY-MM-DD_HH-mm

## 执行概览
- **规划ID**: P00X
- **执行开始时间**: YYYY-MM-DD HH:mm:ss
- **执行结束时间**: YYYY-MM-DD HH:mm:ss
- **总耗时**: X小时Y分钟
- **任务总数**: X个
- **完成任务**: X个
- **失败任务**: X个

## 上下文读取记录
### 核心规划文件
- ✅ plan.json
- ✅ todolist.md
- ✅ rationale.md  
- ✅ feedback.md

### 项目相关文件
[列出从plan.json的referenced_files读取的所有文件]

## 任务状态变更历史
### 任务1: [任务名称]
- 开始时间: YYYY-MM-DD HH:mm:ss - 状态: pending → in_progress
- 完成时间: YYYY-MM-DD HH:mm:ss - 状态: in_progress → completed
- 执行结果: [具体结果描述]

## 工具调用记录
[记录所有工具调用和结果]

## 文件变更记录
### 生成的文件 (generated_files)
- `new/file/path.js` - 新创建的文件

### 修改的文件 (modified_files)
- `existing/file.js` - 修改了现有文件

### 删除的文件 (deleted_files)  
- `old/deprecated/file.js` - 删除的过时文件

## todolist.md状态验证
✅ 所有任务状态已更新完成
- Task 1: [x] 已完成
- Task 2: [x] 已完成
```

## 反馈工作流管理

### 反馈工作流触发
当用户输入包含以下内容时触发反馈工作流：
- 对规划或执行结果的评价（"反馈P001"、"P002如何"）
- 改进建议请求（"有什么建议"、"如何优化"）
- 执行结果评价（"执行效果怎么样"、"有问题吗"）

### 反馈处理流程
1. **读取现有反馈**：使用read_file读取feedback.md
2. **反馈分类识别**：自动识别反馈者类型和内容类别  
3. **结构化记录**：按标准格式追加到feedback.md
4. **状态更新管理**：更新相关反馈的处理状态

### feedback.md标准格式
```markdown
# 反馈记录

## 用户反馈
**时间**: 2024-01-15 10:30  
**反馈者**: 用户反馈  
**类型**: 任务分解修改  
**状态**: 已采纳  
**内容**: 建议将任务3拆分为两个子任务  
**处理结果**: 已在todolist.md中更新任务分解  

## 系统反馈  
**时间**: 2024-01-15 15:45  
**反馈者**: 系统反馈  
**类型**: 性能优化  
**状态**: 已记录  
**内容**: 检测到任务2和任务4可以并行执行  
**处理结果**: 已更新并行执行配置  

## 代理反馈
**时间**: 2024-01-16 08:30  
**反馈者**: 代理反馈  
**类型**: 资源优化  
**状态**: 待处理  
**内容**: 执行任务6时发现可用更高效的工具替代方案  
**处理结果**: 待用户确认后调整工具配置  
```

### 反馈状态管理
- **待处理**: 新收到的反馈，等待分析和处理
- **处理中**: 正在分析或实施的反馈
- **已采纳**: 已接受并实施的反馈  
- **已记录**: 已记录但暂不实施的反馈
- **已拒绝**: 经分析决定不采纳的反馈

## 编号管理规范

### 规划编号规则
- **格式**: P + 3位数字 (P001, P002, P003...)
- **简单易记**: 从P001开始顺序递增
- **便于引用**: 用户只需记住简短编号如"P001"
- **冲突处理**: 扫描现有P001-P999编号，找到下一个可用编号

### 文件夹结构标准
```
todos/
├── P001/
│   ├── plan.json
│   ├── todolist.md
│   ├── rationale.md
│   ├── feedback.md
│   └── reports/
│       ├── exec_001_2024-01-15_14-30.md
│       └── exec_002_2024-01-16_09-15.md
├── P002/
└── P003/
```

## 错误处理和验证

### 必要文件检查
- 规划文件夹存在性验证
- 核心文件完整性检查  
- referenced_files可访问性验证
- 执行权限确认

### 错误恢复策略
- **必读文件缺失**: 中断执行，报告错误
- **可选文件缺失**: 记录警告，继续执行
- **读取权限问题**: 尝试替代方案或跳过

### 状态一致性保障
- 原子操作确保状态更新的一致性
- 执行结束前强制验证todolist.md状态
- 报告生成必须包含状态验证清单

## 工具使用规范

### 必需工具
- `mcp_time_get_current_time`: 获取准确时间（规划生成时必用）
- `list_dir`: 扫描TODOS目录结构（规划生成时必用）
- `read_file`: 并行读取上下文文件（执行前必用）
- `search_replace`/`MultiEdit`: 更新任务状态（执行中必用）
- `write`: 生成报告和文件（执行后必用）

### 并行优化
- 优先使用并行read_file调用提高效率
- 同时读取多个上下文文件
- 批量处理状态更新操作

## 注意事项

### 安全和权限
- 确保Agent具备必要执行权限
- 遵循最小权限原则  
- 重要数据及时备份

### 性能优化
- 智能缓存大型文件
- 分批读取referenced_files
- 避免重复读取未变更文件

### 用户体验
- 及时反馈执行进度
- 清晰的错误信息提示
- 完整的执行结果验证
