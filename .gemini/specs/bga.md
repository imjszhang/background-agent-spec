---
description: Background Agent(BGA)工作流系统 - 当用户提及BGA/规划编号(P001-P999)/复杂多步骤任务/批量自动化/并行处理/执行运行启动/状态进度查看/反馈建议评价时，必须触发此工作流。
alwaysApply: false
---
# Background Agent (BGA) 工作流规则

## 黄金原则 (Golden Rules)
**以下原则是BGA工作流的最高指令，任何情况下都必须严格遵守，不可省略或跳过。**
> 1. **凡有状态转换，必有反馈记录**: 任何导致规划状态变更的重大事件（包括**意图识别**、**执行完成**、**用户反馈**），都**必须**在`feedback.md`中生成对应的结构化反馈记录。
> 2. **先验证，再执行**: 在进入下一个主要阶段前，**必须**完成当前阶段的“强制验证清单”。
> 3. **报告与反馈不可分割**: `reports`目录下的执行报告和`feedback.md`中的执行评估反馈是执行完成后的两个**必要产出**，缺一不可。

## 版本信息
- **当前版本**: v1.4.0
- **发布日期**: 2025-08-04
- **版本状态**: 稳定版 (Stable)
- **基于文档**: `docs/specs/spec.backgroundAgent.README.md` v1.4.0
- **兼容性**: 向后兼容v1.3.0，新增反馈自动化增强功能
- **更新说明**: 集成反馈机制自动化增强功能，包括意图识别后自动反馈和执行结果自动评估机制

## 触发条件智能识别

### 关键词触发检测
当用户输入包含以下任一关键词时，**必须**触发BGA工作流：

**主要触发词**：
- `BGA` / `bga` / `Background Agent` / `后台代理` / `后台助手`

**动作触发词**：
- `执行` + 规划编号（如"执行P001"）
- `运行` + 规划编号（如"运行P002"）  
- `启动` + 规划编号（如"启动P003"）

**查询触发词**：
- 规划编号 + `状态`/`进度`/`结果`（如"P001状态"）
- `查看` + 规划编号（如"查看P001"）

**反馈触发词**：
- `反馈` + 规划编号（如"反馈P001"）
- `建议` + 规划编号（如"建议P001"）
- `评价` + 规划编号（如"评价P001"）
- `优化` + 规划编号（如"优化P002"）

### 上下文智能触发
即使未明确提及BGA，以下情况也**必须**触发工作流：
- 复杂多步骤任务描述（≥3个独立步骤）
- 包含"批量"、"自动化"、"并行"等关键词
- 涉及多个文件或模块的操作
- 包含"帮我规划"、"制定计划"等表述
- 反馈收集场景（"有什么建议"、"如何改进"等）

## 新任务规划生成流程

### 严格按序执行的五步流程
**新任务规划必须严格按以下步骤执行，不可跳过或调换顺序**：

#### 第一步：获取当前时间（强制要求）
```javascript
// 必须使用 mcp_time_get_current_time 工具
await mcp_time_get_current_time({
  timezone: "Asia/Shanghai"
});
```

#### 第二步：分析TODOS目录结构（强制要求）
```javascript
// 必须使用 list_dir 工具扫描 todos/ 目录
await list_dir({
  relative_workspace_path: "todos/"
});
// 分析现有规划数量、已使用编号、目录完整性
```

#### 第三步：建立新规划文件夹结构
```
todos/P00X/
├── plan.json          # 规划配置文件
├── todolist.md        # 任务清单文件  
├── rationale.md       # 执行理由文件
├── feedback.md        # 反馈记录文件
└── reports/           # 执行报告目录
```

#### 第四步：生成核心规划文件
按以下顺序依次生成：
1. **plan.json** - 完整配置和文件引用
2. **todolist.md** - 标准Markdown任务列表
3. **rationale.md** - 详细执行理由
4. **feedback.md** - 空白反馈模板

#### 第五步：流程结束确认
- 验证所有文件创建成功
- 通知用户规划生成完成
- **禁止自动执行** - 必须等待用户明确指令
- **自动反馈生成** - 必须触发意图识别后反馈更新机制

### plan.json标准结构
```json
{
  "plan_id": "P001",
  "title": "规划标题",
  "description": "规划描述", 
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z",
  "status": "pending",
  "referenced_files": {
    "core_files": ["modules/agent.js", "modules/browserAutomation.js"],
    "config_files": ["data/llm_config.example.json"],
    "documentation": ["docs/modules/module.agent.README.md"],
    "test_files": ["test/agent.test.js"]
  },
  "tasks": [
    {
      "id": 1,
      "title": "任务标题",
      "description": "任务描述",
      "status": "pending",
      "dependencies": [],
      "estimated_time": "30min",
      "related_files": ["specific/file.js"]
    }
  ],
  "execution_history": [],
  "metadata": {
    "total_tasks": 5,
    "estimated_total_time": "2hours",
    "complexity": "medium",
    "priority": "high"
  }
}
```

## 执行流程规范

### 执行前强制要求

#### 1. 上下文读取（read_context）- 必须执行
**并行读取所有必要文件**：
- **核心规划文件**：plan.json、todolist.md、rationale.md、feedback.md
- **项目相关文件**：plan.json中referenced_files字段的所有文件
- **执行历史文件**（继续执行时）：reports/目录下所有执行报告
- **产出文件**（继续执行时）：历史报告中的generated_files和modified_files

```javascript
// 示例：并行读取上下文文件
const contextFiles = [
  `todos/${planId}/plan.json`,
  `todos/${planId}/todolist.md`,
  `todos/${planId}/rationale.md`, 
  `todos/${planId}/feedback.md`,
  ...referencedFiles,
  ...reportFiles,
  ...generatedFiles
];

// 使用并行read_file调用
await Promise.all(
  contextFiles.map(file => read_file(file))
);
```

#### 2. 执行前验证
- 规划有效性检查
- 依赖关系验证
- 资源可用性检查
- 文件状态验证

#### 3. 执行前强制验证清单
在正式开始执行任务前，必须完成以下检查：
- [ ] **意图识别反馈已记录**: `feedback.md`中是否已添加本次执行的“意图识别反馈”？
- [ ] **上下文已完整读取**: `plan.json`中引用的所有必要文件是否已成功读取？
- [ ] **规划状态有效性**: `plan.json`中的状态是否为`pending`或`in_progress`？

### 意图识别后自动反馈更新机制（V1.4.0新增）

#### 强制要求
每次意图识别完成后，系统**必须**自动更新相关规划的feedback.md文件：

#### 1. 识别结果记录
- **识别时间戳**：记录意图识别的精确时间
- **识别类型**：明确识别到的意图类型（新任务规划、执行已有规划等）
- **置信度评估**：系统对识别结果的置信度评分（1-10分）
- **触发条件分析**：详细记录触发意图识别的关键词和上下文

#### 2. 风险评估机制
- **误识别风险**：基于置信度和上下文复杂度评估误识别可能性
- **冲突检测**：检查识别结果是否与用户历史行为模式一致
- **安全性评估**：评估执行意图可能带来的安全风险
- **资源消耗预估**：预估执行意图所需的系统资源

#### 3. 自动反馈生成
- **反馈者类型**：标记为"系统反馈"
- **反馈内容**：包含识别结果、风险评估、建议措施
- **状态标记**：初始状态为"已记录"，待用户确认后可调整
- **改进建议**：基于识别结果提供流程优化建议

#### 4. 反馈更新流程模板
```markdown
## 意图识别反馈 - [时间戳]
**时间**: YYYY-MM-DD HH:mm:ss  
**反馈者**: 系统反馈  
**类型**: 意图识别结果  
**状态**: 已记录  
**识别类型**: [新任务规划|执行已有规划|查看执行结果|修改现有规划|规划管理|反馈工作流]  
**置信度**: [1-10]/10  
**触发条件**: [具体的关键词和上下文分析]  
**风险评估**: [误识别风险等级：低|中|高]  
**内容**: 用户意图识别完成，识别为[具体意图类型]，置信度[X/10]。[详细分析和建议]  
**处理结果**: 等待执行或用户确认  
```

#### 5. 质量保证机制
- **一致性检查**：确保识别结果与用户表达的一致性
- **历史对比**：与用户历史交互模式进行对比验证
- **实时调整**：基于用户反馈实时调整识别算法参数
- **学习优化**：将反馈数据用于持续优化意图识别准确性

### 强制状态跟踪（todo_write）

#### 任务状态管理规范
todolist.md使用标准状态标记，**执行过程中必须严格更新**：

```markdown
## 任务清单

- [ ] 1. 任务名称 - 待执行 (pending)
- [~] 2. 任务名称 - 执行中 (in_progress)  
- [x] 3. 任务名称 - 已完成 (completed)
- [!] 4. 任务名称 - 执行失败 (failed)
- [-] 5. 任务名称 - 已跳过 (skipped)
```

#### 强制状态更新要求
1. **任务开始时**：必须将状态从`[ ]`更新为`[~]`
2. **任务完成时**：必须将状态从`[~]`更新为`[x]`或`[!]`
3. **实时同步**：todolist.md状态必须与实际执行进度同步
4. **状态验证**：执行结束前必须验证所有任务状态正确更新

#### todo_write工具实现
```javascript
// 使用 search_replace 或 MultiEdit 工具直接修改 todolist.md
await search_replace({
  file_path: `todos/${planId}/todolist.md`,
  old_string: "- [ ] 1. 任务名称",
  new_string: "- [~] 1. 任务名称"
});
```

## 执行收尾与验证流程 (Execution Completion & Verification)

**任务执行完成后，必须严格按照以下顺序完成收尾工作，并完成最终验证。**

### 第一步：更新todolist.md状态
- **强制要求**：确认`todolist.md`中所有任务的状态（`[x]`, `[!]`, `[-]`）都已更新为最终状态。

### 第二步：生成执行结果评估反馈 (强制要求)
- **强制要求**：系统**必须**自动执行结果评估，并将结构化的评估报告追加到`feedback.md`文件中。
- **关联**：此步骤的产出是`feedback.md`中的一条新的“执行结果评估反馈”记录。
> **注意：此步骤是执行完成的标志之一，不可遗漏。**

### 第三步：生成执行报告 (强制要求)
- **强制要求**：**必须**在`reports/`目录下创建本次执行的详细报告。
- **关联**：此步骤的产出是一个新的`exec_...md`文件。
> **注意：此步骤是执行完成的标志之二，不可遗漏。**

### 第四步：执行完毕强制验证清单
在宣告规划执行完毕前，必须完成以下最终检查：
- [ ] **任务清单已终结**: `todolist.md`中的所有任务是否都有明确的最终状态？
- [ ] **执行报告已生成**: `reports/`目录下是否已生成本次执行的`exec_...md`报告？
- [ ] **执行评估已反馈**: `feedback.md`中是否已添加本次执行的“执行结果评估反馈”？

## 执行报告生成规范

### 强制报告生成要求
每次执行完成后**必须**创建执行报告：

#### 报告命名格式
```
todos/P00X/reports/exec_序号_YYYY-MM-DD_HH-mm.md
```

#### 标准报告模板
```markdown
# 规划执行报告 - exec_001_YYYY-MM-DD_HH-mm

## 执行概览
- **规划ID**: P00X
- **执行开始时间**: YYYY-MM-DD HH:mm:ss
- **执行结束时间**: YYYY-MM-DD HH:mm:ss
- **总耗时**: X小时Y分钟
- **任务总数**: X个
- **完成任务**: X个
- **失败任务**: X个

## 上下文读取记录
### 核心规划文件
- ✅ plan.json
- ✅ todolist.md
- ✅ rationale.md  
- ✅ feedback.md

### 项目相关文件
[列出从plan.json的referenced_files读取的所有文件]

## 任务状态变更历史
### 任务1: [任务名称]
- 开始时间: YYYY-MM-DD HH:mm:ss - 状态: pending → in_progress
- 完成时间: YYYY-MM-DD HH:mm:ss - 状态: in_progress → completed
- 执行结果: [具体结果描述]

## 工具调用记录
[记录所有工具调用和结果]

## 文件变更记录
### 生成的文件 (generated_files)
- `new/file/path.js` - 新创建的文件

### 修改的文件 (modified_files)
- `existing/file.js` - 修改了现有文件

### 删除的文件 (deleted_files)  
- `old/deprecated/file.js` - 删除的过时文件

## todolist.md状态验证
✅ 所有任务状态已更新完成
- Task 1: [x] 已完成
- Task 2: [x] 已完成
```

## 反馈工作流管理

### 反馈工作流触发
当用户输入包含以下内容时触发反馈工作流：
- 对规划或执行结果的评价（"反馈P001"、"P002如何"）
- 改进建议请求（"有什么建议"、"如何优化"）
- 执行结果评价（"执行效果怎么样"、"有问题吗"）

### 反馈处理流程
1. **读取现有反馈**：使用read_file读取feedback.md
2. **反馈分类识别**：自动识别反馈者类型和内容类别  
3. **结构化记录**：按标准格式追加到feedback.md
4. **状态更新管理**：更新相关反馈的处理状态

### feedback.md标准格式
```markdown
# 反馈记录

## 用户反馈
**时间**: 2024-01-15 10:30  
**反馈者**: 用户反馈  
**类型**: 任务分解修改  
**状态**: 已采纳  
**内容**: 建议将任务3拆分为两个子任务  
**处理结果**: 已在todolist.md中更新任务分解  

## 系统反馈  
**时间**: 2024-01-15 15:45  
**反馈者**: 系统反馈  
**类型**: 性能优化  
**状态**: 已记录  
**内容**: 检测到任务2和任务4可以并行执行  
**处理结果**: 已更新并行执行配置  

## 代理反馈
**时间**: 2024-01-16 08:30  
**反馈者**: 代理反馈  
**类型**: 资源优化  
**状态**: 待处理  
**内容**: 执行任务6时发现可用更高效的工具替代方案  
**处理结果**: 待用户确认后调整工具配置  
```

### 反馈状态管理
- **待处理**: 新收到的反馈，等待分析和处理
- **处理中**: 正在分析或实施的反馈
- **已采纳**: 已接受并实施的反馈  
- **已记录**: 已记录但暂不实施的反馈
- **已拒绝**: 经分析决定不采纳的反馈

## 编号管理规范

### 规划编号规则
- **格式**: P + 3位数字 (P001, P002, P003...)
- **简单易记**: 从P001开始顺序递增
- **便于引用**: 用户只需记住简短编号如"P001"
- **冲突处理**: 扫描现有P001-P999编号，找到下一个可用编号

### 文件夹结构标准
```
todos/
├── P001/
│   ├── plan.json
│   ├── todolist.md
│   ├── rationale.md
│   ├── feedback.md
│   └── reports/
│       ├── exec_001_2024-01-15_14-30.md
│       └── exec_002_2024-01-16_09-15.md
├── P002/
└── P003/
```

## 错误处理和验证

### 必要文件检查
- 规划文件夹存在性验证
- 核心文件完整性检查  
- referenced_files可访问性验证
- 执行权限确认

### 错误恢复策略
- **必读文件缺失**: 中断执行，报告错误
- **可选文件缺失**: 记录警告，继续执行
- **读取权限问题**: 尝试替代方案或跳过

### 状态一致性保障
- 原子操作确保状态更新的一致性
- 执行结束前强制验证todolist.md状态
- 报告生成必须包含状态验证清单

## 工具使用规范

### 必需工具
- `mcp_time_get_current_time`: 获取准确时间（规划生成时必用）
- `list_dir`: 扫描TODOS目录结构（规划生成时必用）
- `read_file`: 并行读取上下文文件（执行前必用）
- `search_replace`/`MultiEdit`: 更新任务状态（执行中必用）
- `write`: 生成报告和文件（执行后必用）

### V1.4.0新增工具要求
- **意图识别反馈工具**: 自动更新feedback.md文件的意图识别结果
- **执行评估反馈工具**: 自动生成执行结果评估反馈
- **置信度评估工具**: 评估意图识别的置信度（1-10分）
- **风险评估工具**: 评估执行意图的安全风险和资源消耗
- **质量评估工具**: 多维度评估执行结果质量（完成度、效率、错误率等）
- **问题发现工具**: 自动检测执行过程中的异常和性能瓶颈
- **优化建议生成工具**: 基于执行结果生成改进建议

### 并行优化
- 优先使用并行read_file调用提高效率
- 同时读取多个上下文文件
- 批量处理状态更新操作

## 注意事项

### 安全和权限
- 确保Agent具备必要执行权限
- 遵循最小权限原则  
- 重要数据及时备份

### 性能优化
- 智能缓存大型文件
- 分批读取referenced_files
- 避免重复读取未变更文件

### 用户体验
- 及时反馈执行进度
- 清晰的错误信息提示
- 完整的执行结果验证

### V1.4.0版本特别注意事项
- **意图识别准确性**: 确保意图识别系统的置信度评估准确，避免误识别导致的错误操作
- **自动反馈质量**: 保证意图识别后和执行完毕后的自动反馈内容准确、有用
- **反馈触发时机**: 严格按照规定的时机触发自动反馈更新，不得遗漏或重复
- **评估结果可信度**: 确保质量评估、风险评估等自动评估结果的可靠性
- **持续改进效果**: 验证基于反馈数据的持续改进机制是否真正提升了系统性能
- **用户确认机制**: 对于自动生成的重要建议，需要用户确认后再执行
- **反馈数据隐私**: 确保反馈记录中不包含敏感信息，遵守数据保护原则
